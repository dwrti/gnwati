<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مشغل متزامن مطور</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #000; overflow: hidden; }
        video { width: 100%; height: 100%; outline: none; }
    </style>
</head>
<body>

    <video id="v" controls autoplay playsinline></video>

    <script>
        var v = document.getElementById('v'), h = new Hls(), last = "",
            db = "https://axnt-68677-default-rtdb.europe-west1.firebasedatabase.app/live_stream.json";

        function sync() {
            fetch(db).then(r => r.json()).then(data => {
                if (!data || data.syncEnabled === false) return;

                // 1. تحديث الرابط فقط إذا تغير فعلياً
                if (data.url !== last) {
                    last = data.url;
                    if (Hls.isSupported() && (last.includes('m3u8'))) {
                        h.destroy(); 
                        h = new Hls({ lowLatencyMode: true }); // وضع التأخير المنخفض لتحسين الأداء
                        h.loadSource(last); 
                        h.attachMedia(v);
                    } else { v.src = last; }
                }

                // 2. مزامنة الحالة (تشغيل/إيقاف)
                if (data.status === "playing" && v.paused) {
                    v.play().catch(() => { v.muted = true; v.play(); });
                } else if (data.status === "paused" && !v.paused) {
                    v.pause();
                }

                // 3. المزامنة الزمنية "الذكية"
                // زدنا الفرق إلى 5 ثوانٍ لتقليل القفزات المتكررة
                var diff = Math.abs(v.currentTime - data.time);
                if (data.status === "playing" && diff > 5) {
                    v.currentTime = data.time;
                }
            });
        }

        // تحديث كل 5 ثوانٍ لتقليل الضغط على المتصفح
        setInterval(sync, 5000);
        sync();
    </script>
</body>
</html>
