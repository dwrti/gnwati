<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø´Ø§Ø´Ø© Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© ğŸ“º</title>
    
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    
    <style>
        /* ØªØµÙ…ÙŠÙ… Ø³ÙŠÙ†Ù…Ø§Ø¦ÙŠ - Ø´Ø§Ø´Ø© ÙƒØ§Ù…Ù„Ø© */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body, html { 
            width: 100%; height: 100%; 
            background-color: #000; 
            overflow: hidden; 
            font-family: sans-serif;
        }

        .video-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: contain; /* ÙŠØ­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ø£Ø¨Ø¹Ø§Ø¯ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø£ØµÙ„ÙŠ */
        }

        /* ØªÙ†Ø¨ÙŠÙ‡ ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª */
        #muteOverlay {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 0, 0, 0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 30px;
            cursor: pointer;
            z-index: 100;
            display: none;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .status-dot {
            position: absolute;
            bottom: 10px;
            left: 10px;
            width: 10px;
            height: 10px;
            background: #4caf50;
            border-radius: 50%;
            opacity: 0.5;
        }
    </style>
</head>
<body>

    <div class="video-container">
        <div id="muteOverlay" onclick="unmuteVideo()">Ø§Ø¶ØºØ· Ù‡Ù†Ø§ Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª ğŸ”Š</div>
        <video id="remotePlayer" playsinline></video>
        <div class="status-dot"></div>
    </div>

    <script>
        var video = document.getElementById('remotePlayer');
        var muteOverlay = document.getElementById('muteOverlay');
        var hls = new Hls();
        var dbUrl = "https://axnt-68677-default-rtdb.europe-west1.firebasedatabase.app/live_stream.json";
        var presenceUrl = "https://axnt-68677-default-rtdb.europe-west1.firebasedatabase.app/presence";
        var lastUrl = "";
        var myUserId = "viewer_" + Math.random().toString(36).substring(7);

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙˆØ§Ø¬Ø¯ (Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…ØªØµÙ„ÙŠÙ† Ø¹Ù†Ø¯ Ø§Ù„Ø£Ø¯Ù…Ù†)
        function updatePresence() {
            var xhr = new XMLHttpRequest();
            xhr.open("PUT", presenceUrl + "/" + myUserId + ".json", true);
            xhr.send(JSON.stringify(Date.now()));
        }

        function playMedia(url) {
            if (!url) { 
                video.src = ""; 
                if (hls) hls.destroy(); 
                lastUrl = ""; 
                return; 
            }
            if (url === lastUrl) return;
            lastUrl = url;

            if (Hls.isSupported() && (url.includes('m3u8') || url.includes('.ts'))) {
                hls.destroy();
                hls = new Hls();
                hls.loadSource(url);
                hls.attachMedia(video);
            } else {
                video.src = url;
            }

            attemptPlay();
        }

        function attemptPlay() {
            var playPromise = video.play();
            if (playPromise !== undefined) {
                playPromise.catch(function() {
                    video.muted = true;
                    video.play();
                    muteOverlay.style.display = "block";
                });
            }
        }

        function unmuteVideo() {
            video.muted = false;
            muteOverlay.style.display = "none";
        }

        function syncWithDatabase() {
            var xhr = new XMLHttpRequest();
            xhr.open("GET", dbUrl, true);
            xhr.onload = function() {
                if (xhr.status === 200) {
                    var data = JSON.parse(xhr.responseText);
                    if (!data || data.syncEnabled === false) return;

                    // 1. Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø±Ø§Ø¨Ø·
                    if (data.url !== lastUrl) {
                        playMedia(data.url);
                    }

                    // 2. Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ÙˆÙ‚Øª (Ø¥Ø°Ø§ Ø²Ø§Ø¯ Ø§Ù„ÙØ§Ø±Ù‚ Ø¹Ù† Ø«Ø§Ù†ÙŠØªÙŠÙ†)
                    var timeDiff = Math.abs(video.currentTime - data.time);
                    if (timeDiff > 2) {
                        video.currentTime = data.time;
                    }

                    // 3. Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø­Ø§Ù„Ø© (ØªØ´ØºÙŠÙ„/Ø¥ÙŠÙ‚Ø§Ù)
                    if (data.status === "playing" && video.paused) {
                        attemptPlay();
                    } else if (data.status === "paused" && !video.paused) {
                        video.pause();
                    }
                }
            };
            xhr.send();
        }

        // ØªØ­Ø¯ÙŠØ« Ø¯ÙˆØ±ÙŠ Ø³Ø±ÙŠØ¹ Ù„Ù„Ù…Ø²Ø§Ù…Ù†Ø© (ÙƒÙ„ Ø«Ø§Ù†ÙŠØ© Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø¯Ù‚Ø©)
        setInterval(function() {
            syncWithDatabase();
            updatePresence();
        }, 1000);

        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ Ø¹Ù†Ø¯ Ø£ÙˆÙ„ ØªÙØ§Ø¹Ù„ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¹ Ø§Ù„ØµÙØ­Ø©
        document.body.addEventListener('click', function() {
            if (video.paused && lastUrl) attemptPlay();
        }, { once: true });

    </script>
</body>
</html>
