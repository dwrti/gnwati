<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø´ØºÙ„ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø³Ø±ÙŠØ¹ âš¡</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        :root { --primary: #007bff; --bg: #0a0a0a; --card: #161616; --text: #e0e0e0; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: system-ui, -apple-system, sans-serif; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        
        /* Ù…Ø´ØºÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ */
        .video-container { width: 100%; max-width: 900px; background: #000; position: sticky; top: 0; z-index: 100; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        video { width: 100%; aspect-ratio: 16/9; display: block; }

        /* Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… */
        .controls { width: 90%; max-width: 800px; padding: 20px; margin-top: 20px; }
        .admin-panel { display: none; background: var(--card); padding: 15px; border-radius: 12px; border: 1px solid #333; margin-bottom: 20px; }
        
        input { width: 100%; padding: 12px; margin: 8px 0; background: #000; border: 1px solid #444; border-radius: 8px; color: #fff; box-sizing: border-box; }
        button { cursor: pointer; padding: 10px 20px; border: none; border-radius: 8px; font-weight: bold; transition: 0.3s; }
        .btn-main { background: var(--primary); color: white; width: 100%; margin-top: 10px; }
        .btn-main:hover { opacity: 0.8; }
        
        /* Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø© */
        .status-bar { display: flex; justify-content: space-between; font-size: 12px; color: #888; margin-top: 10px; }
        .badge { padding: 4px 8px; border-radius: 4px; background: #222; }
        .live-count { color: #4caf50; }

        /* Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª */
        #toast { position: fixed; bottom: 20px; right: 20px; background: var(--primary); color: white; padding: 10px 20px; border-radius: 8px; display: none; z-index: 1000; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="video-container">
    <video id="player" controls playsinline></video>
</div>

<div class="controls">
    <div id="adminArea" class="admin-panel">
        <h3 style="margin-top:0">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… (Ø£Ø¯Ù…Ù†) ğŸ› ï¸</h3>
        <input type="text" id="streamUrl" placeholder="Ø¶Ø¹ Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø£Ùˆ Ø§Ù„Ø¨Ø« Ù‡Ù†Ø§...">
        <button class="btn-main" onclick="updateStream()">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨Ø« Ù„Ù„Ø¬Ù…ÙŠØ¹ ğŸ“¡</button>
        <div class="status-bar">
            <span class="badge">Ø§Ù„Ù…ØªØµÙ„ÙŠÙ†: <span id="count" class="live-count">1</span></span>
            <span id="syncStatus" class="badge">Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ù†Ø´Ø·Ø© âœ…</span>
        </div>
    </div>

    <div class="status-bar" id="viewerStatus">
        <span>ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ù…ØªØ²Ø§Ù…Ù†Ø©</span>
        <span id="connectionDot" style="color: #4caf50;">â— Ù…ØªØµÙ„</span>
    </div>
</div>

<div id="toast"></div>

<script>
    const video = document.getElementById('player');
    const dbUrl = "https://axnt-68677-default-rtdb.europe-west1.firebasedatabase.app/live_stream.json";
    const isAdmin = window.location.hash === "#ana";
    let lastUrl = "";
    let isLocked = false; // Ù„Ù…Ù†Ø¹ Ø­Ù„Ù‚Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù„Ø§Ù†Ù‡Ø§Ø¦ÙŠØ©

    // Ø¥Ø¸Ù‡Ø§Ø± Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù†
    if (isAdmin) {
        document.getElementById('adminArea').style.display = 'block';
        document.getElementById('viewerStatus').style.display = 'none';
    }

    // Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø°ÙƒÙŠØ© (HLS Ø£Ùˆ Ø¹Ø§Ø¯ÙŠ)
    function loadVideo(url) {
        if (!url || url === lastUrl) return;
        lastUrl = url;
        if (Hls.isSupported() && url.includes('.m3u8')) {
            const hls = new Hls();
            hls.loadSource(url);
            hls.attachMedia(video);
        } else {
            video.src = url;
        }
        video.play().catch(() => {
            showToast("ØªÙ… ÙƒØªÙ… Ø§Ù„ØµÙˆØª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ - Ø§Ø¶ØºØ· Ù„ØªÙØ¹ÙŠÙ„Ù‡");
            video.muted = true;
        });
    }

    // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ù„Ù„Ø£Ø¯Ù…Ù† ÙÙ‚Ø·)
    function updateStream() {
        const url = document.getElementById('streamUrl').value;
        if (!url) return;
        fetch(dbUrl, {
            method: 'PATCH',
            body: JSON.stringify({ url: url, time: 0, status: "playing", lastUpdated: Date.now() })
        });
        showToast("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø§Ø¨Ø· Ø¨Ù†Ø¬Ø§Ø­ âœ…");
    }

    function syncToCloud() {
        if (!isAdmin || video.paused) return;
        fetch(dbUrl, {
            method: 'PATCH',
            body: JSON.stringify({ time: video.currentTime, status: "playing" })
        });
    }

    // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ù„Ù„Ù…Ø´Ø§Ù‡Ø¯ÙŠÙ†)
    async function listenToCloud() {
        try {
            const response = await fetch(dbUrl);
            const data = await response.json();
            if (!data) return;

            if (!isAdmin) {
                loadVideo(data.url);
                // Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ÙˆÙ‚Øª Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ÙØ§Ø±Ù‚ Ø£ÙƒØ¨Ø± Ù…Ù† 3 Ø«ÙˆØ§Ù†ÙŠ
                if (Math.abs(video.currentTime - data.time) > 3) {
                    video.currentTime = data.time;
                }
                // Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø­Ø§Ù„Ø© (ØªØ´ØºÙŠÙ„/Ø¥ÙŠÙ‚Ø§Ù)
                if (data.status === "playing" && video.paused) video.play();
                if (data.status === "paused" && !video.paused) video.pause();
            }
        } catch (e) { console.error("Sync Error"); }
    }

    // Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª
    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg;
        t.style.display = 'block';
        setTimeout(() => t.style.display = 'none', 3000);
    }

    // Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¯ÙˆØ±ÙŠ
    setInterval(() => {
        listenToCloud();
        if (isAdmin) syncToCloud();
    }, 2000); // ØªØ­Ø¯ÙŠØ« ÙƒÙ„ Ø«Ø§Ù†ÙŠØªÙŠÙ† Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø³Ø±Ø¹Ø©

</script>
</body>
</html>
