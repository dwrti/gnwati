<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø´Ø§Ù‡Ø¯Ø© ğŸ“º</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        body, html { margin: 0; padding: 0; background: #000; width: 100%; height: 100%; overflow: hidden; }
        video { width: 100%; height: 100vh; background: #000; }
        #status { position: fixed; top: 10px; right: 10px; color: #4caf50; font-size: 12px; z-index: 10; pointer-events: none; }
    </style>
</head>
<body>
    <div id="status">Ù…ØªØµÙ„ â—</div>
    <video id="v" controls autoplay playsinline></video>

    <script>
        const video = document.getElementById('v');
        const hls = new Hls();
        const dbUrl = "https://axnt-68677-default-rtdb.europe-west1.firebasedatabase.app/live_stream.json";
        let lastUrl = "";

        function play(url) {
            if (!url || url === lastUrl) return;
            lastUrl = url;
            if (Hls.isSupported() && url.includes('m3u8')) {
                hls.loadSource(url); hls.attachMedia(video);
            } else { video.src = url; }
            video.play().catch(() => video.muted = true);
        }

        async function sync() {
            try {
                const res = await fetch(dbUrl);
                const data = await res.json();
                if (!data || data.syncEnabled === false) return;

                // Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø±Ø§Ø¨Ø·
                play(data.url);

                // Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ÙˆÙ‚Øª (ÙØ±Ù‚ Ø£ÙƒØ«Ø± Ù…Ù† 3 Ø«ÙˆØ§Ù†ÙŠ)
                if (Math.abs(video.currentTime - data.time) > 3) {
                    video.currentTime = data.time;
                }

                // Ù…Ø²Ø§Ù…Ù†Ø© Ø­Ø§Ù„Ø© Ø§Ù„ØªØ´ØºÙŠÙ„
                if (data.status === "playing" && video.paused) video.play();
                else if (data.status === "paused" && !video.paused) video.pause();
                
            } catch (e) { console.error("Sync Error"); }
        }

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© ÙƒÙ„ Ø«Ø§Ù†ÙŠØªÙŠÙ†
        setInterval(sync, 2000);
        
        // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙˆØ§Ø¬Ø¯ (Presence)
        const myId = Math.random().toString(36).substr(7);
        setInterval(() => {
            fetch(`https://axnt-68677-default-rtdb.europe-west1.firebasedatabase.app/presence/${myId}.json`, {
                method: 'PUT', body: JSON.stringify(Date.now())
            });
        }, 5000);
    </script>
</body>
</html>
